# Cursor Rule 自动安装设计

## 背景

用户在使用 Skillix MCP Server 时，需要一个明确的指引让 AI 知道何时以及如何调用 `sx-dispatch` 进行智能分流。通过 Cursor Rule（.mdc 文件）可以实现这一目标。

## 问题

1. **AI 不会自动知道何时使用 Skillix**：虽然 MCP 工具已注册，但 AI 需要明确的指引才知道在什么场景下调用 `sx-dispatch`
2. **新用户学习成本高**：需要手动了解和配置使用流程
3. **缺乏统一的工作流程**：不同用户可能有不同的使用方式

## 解决方案

### 设计目标

1. 在 `sx-config init` 命令中自动安装 Cursor Rule
2. 提供标准化的 Skillix 使用流程
3. 降低新用户的学习成本

### 实现方案

#### 1. 创建规则模板

在 `src/templates/skillix-rule.ts` 中定义规则内容：

```typescript
export const SKILLIX_RULE_CONTENT = `---
description: Skillix 智能分流规则 - 每次会话自动调用 sx-dispatch 进行任务分析
globs:
alwaysApply: true
---

# Skillix 使用规范

## 会话启动流程

每次新会话开始时，如果用户提出了一个任务需求，应该：

1. 首先调用 sx-dispatch 分析任务
2. 根据返回结果决定下一步操作
3. 执行任务
4. 反馈与进化（可选）
`;

export const SKILLIX_RULE_FILENAME = 'skillix.mdc';
```

#### 2. 修改 sx-config init 命令

在 `src/tools/configs/init.ts` 中添加规则安装逻辑：

```typescript
function installCursorRule(projectRoot: string): { installed: boolean; path: string; message: string } {
  const cursorRulesDir = path.join(projectRoot, '.cursor', 'rules');
  const rulePath = path.join(cursorRulesDir, SKILLIX_RULE_FILENAME);
  
  // 检查是否已存在
  if (fs.exists(rulePath)) {
    return {
      installed: false,
      path: rulePath,
      message: 'Cursor Rule 已存在，跳过安装',
    };
  }
  
  // 确保目录存在并写入规则文件
  fs.ensureDir(cursorRulesDir);
  fs.writeFile(rulePath, SKILLIX_RULE_CONTENT);
  
  return {
    installed: true,
    path: rulePath,
    message: '成功安装 Cursor Rule',
  };
}
```

### 用户使用流程

```
1. 配置 ~/.cursor/mcp.json（添加 skillix MCP Server）
2. 在项目中执行 sx-config action=init projectRoot="/path/to/project"
3. 自动获得：
   - .skillix/ 目录（项目配置和技能存储）
   - .cursor/rules/skillix.mdc（Cursor Rule）
4. 开始使用！
```

### 目录结构

执行 `sx-config init` 后，项目结构如下：

```
project/
├── .skillix/
│   ├── config.json        # 项目配置
│   ├── skills/            # 项目级技能
│   └── logs/              # 项目日志
└── .cursor/
    └── rules/
        └── skillix.mdc    # Skillix 使用规则
```

### 规则内容说明

skillix.mdc 规则包含以下内容：

1. **会话启动流程**：指导 AI 在每次会话开始时调用 `sx-dispatch`
2. **操作类型说明**：解释各种返回操作类型的含义和下一步操作
3. **可用工具列表**：列出所有 Skillix 工具及其用途
4. **示例工作流**：提供具体的使用示例

### 优势

1. **一键配置**：用户只需执行一条命令即可完成所有配置
2. **标准化流程**：确保所有用户遵循相同的最佳实践
3. **自动触发**：Cursor Rule 会自动指导 AI 使用 Skillix
4. **可定制**：用户可以根据需要修改规则内容

## 相关文件

- `src/templates/skillix-rule.ts` - 规则模板
- `src/tools/configs/init.ts` - init 命令实现
- `.cursor/rules/skillix.mdc` - 安装后的规则文件

## 后续优化

1. 支持规则版本更新检测
2. 提供 `sx-config action=update-rule` 命令更新规则
3. 支持自定义规则模板
