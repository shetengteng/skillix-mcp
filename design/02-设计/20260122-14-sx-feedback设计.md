# sx-feedback 设计文档

## 概述

`sx-feedback` 是 Skillix 的技能反馈管理工具，用于记录和分析技能使用反馈，帮助 AI 代理了解技能的执行效果，并为技能进化提供数据支持。

## 设计目标

1. **记录反馈** - 记录每次技能执行的结果（成功/失败/部分成功）
2. **分析表现** - 分析技能的历史表现，计算成功率
3. **建议更新** - 根据反馈数据判断技能是否需要更新
4. **支持进化** - 为技能的自动进化提供数据基础

## 工作流程

### 1. 反馈记录流程

```
用户使用技能完成任务
        ↓
AI 代理判断执行结果
        ↓
调用 sx-feedback action=record
        ↓
记录反馈到本地存储
        ↓
返回记录结果
```

### 2. 反馈分析流程

```
AI 代理需要了解技能健康度
        ↓
调用 sx-feedback action=analyze
        ↓
读取历史反馈数据
        ↓
计算成功率、失败次数等指标
        ↓
判断是否建议更新
        ↓
返回分析结果和建议
```

### 3. 技能进化触发流程

```
定期分析 / 失败后分析
        ↓
发现技能需要更新
        ↓
提供更新建议
        ↓
AI 代理读取技能内容
        ↓
根据失败原因更新技能
```

## 操作类型

### record - 记录反馈

记录一次技能执行的反馈。

**参数：**
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| skillName | string | ✅ | 技能名称 |
| result | string | ✅ | 执行结果：success, failure, partial |
| task | string | ❌ | 任务描述 |
| notes | string | ❌ | 备注信息（如错误原因） |
| scope | string | ❌ | 范围：global, project（默认 global） |
| projectRoot | string | ❌ | 项目根目录 |

**示例：**
```bash
# 记录成功
sx-feedback action=record skillName="pdf-converter" result="success" task="转换 PDF 为图片"

# 记录失败
sx-feedback action=record skillName="pdf-converter" result="failure" notes="pdftoppm 命令不存在"

# 记录部分成功
sx-feedback action=record skillName="data-processor" result="partial" notes="只处理了部分数据"
```

### list - 列出反馈

列出反馈记录，支持按技能名称和时间范围过滤。

**参数：**
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| skillName | string | ❌ | 技能名称（不指定则列出所有） |
| days | number | ❌ | 时间范围（天） |
| scope | string | ❌ | 范围：global, project（默认 global） |
| projectRoot | string | ❌ | 项目根目录 |

**示例：**
```bash
# 列出所有反馈
sx-feedback action=list

# 列出指定技能的反馈
sx-feedback action=list skillName="pdf-converter"

# 列出最近 7 天的反馈
sx-feedback action=list skillName="pdf-converter" days=7
```

### analyze - 分析反馈

分析技能的反馈数据，判断是否需要更新。

**参数：**
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| skillName | string | ✅ | 技能名称 |
| days | number | ❌ | 分析时间范围（默认 30 天） |
| scope | string | ❌ | 范围：global, project（默认 global） |
| projectRoot | string | ❌ | 项目根目录 |

**示例：**
```bash
sx-feedback action=analyze skillName="pdf-converter"
```

**返回数据：**
```json
{
  "success": true,
  "message": "技能 \"pdf-converter\" 建议更新: 近期失败 3 次",
  "data": {
    "analysis": {
      "skillName": "pdf-converter",
      "totalCount": 10,
      "successCount": 5,
      "failureCount": 3,
      "partialCount": 2,
      "successRate": "50.0%",
      "shouldUpdate": true,
      "updateReason": "近期失败 3 次，建议检查技能是否需要更新"
    },
    "recentFeedbacks": [...],
    "nextSteps": [
      "使用 sx-skill action=read name=\"pdf-converter\" 查看技能内容",
      "分析失败原因后使用 sx-skill action=update 更新技能"
    ]
  }
}
```

### clear - 清除反馈

清除反馈记录。

**参数：**
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| skillName | string | ❌ | 技能名称（不指定则清除所有） |
| scope | string | ❌ | 范围：global, project（默认 global） |
| projectRoot | string | ❌ | 项目根目录 |

**示例：**
```bash
# 清除指定技能的反馈
sx-feedback action=clear skillName="pdf-converter"

# 清除所有反馈
sx-feedback action=clear
```

## 更新判断规则

系统根据以下规则判断技能是否需要更新：

| 规则 | 条件 | 说明 |
|------|------|------|
| 多次失败 | 失败次数 >= 3 | 技能可能存在问题 |
| 低成功率 | 成功率 < 50% 且样本 >= 5 | 技能表现不佳 |
| 频繁部分成功 | 部分成功 >= 3 且 > 成功次数 | 技能功能可能不完整 |

## 数据存储

### 存储位置

- **全局反馈**: `~/.skillix/data/feedbacks.json`
- **项目反馈**: `.skillix/data/feedbacks.json`

### 数据结构

```typescript
interface SkillFeedbackFile {
  version: string;           // 文件版本
  updatedAt: string;         // 最后更新时间
  feedbacks: SkillFeedback[];
}

interface SkillFeedback {
  id: string;                // 反馈 ID
  skillName: string;         // 技能名称
  result: 'success' | 'failure' | 'partial';  // 执行结果
  task?: string;             // 任务描述
  notes?: string;            // 备注信息
  timestamp: string;         // 记录时间
}
```

## 与其他工具的协作

### 与 sx-dispatch 协作

```
sx-dispatch 分析任务
        ↓
推荐使用某个技能
        ↓
AI 代理执行技能
        ↓
sx-feedback 记录结果
        ↓
下次 sx-dispatch 可参考反馈数据
```

### 与 sx-skill 协作

```
sx-feedback 分析发现需要更新
        ↓
sx-skill action=read 读取技能内容
        ↓
AI 代理分析失败原因
        ↓
sx-skill action=update 更新技能
        ↓
技能进化完成
```

## 最佳实践

1. **及时记录** - 每次使用技能后及时记录反馈
2. **详细备注** - 失败时记录详细的错误信息
3. **定期分析** - 定期使用 analyze 检查技能健康度
4. **清理数据** - 定期清理过期的反馈记录

## 文件结构

```
src/tools/feedbacks/
├── index.ts      # 工具入口和定义
├── record.ts     # record 操作
├── list.ts       # list 操作
├── analyze.ts    # analyze 操作
└── clear.ts      # clear 操作

src/services/feedback/
└── index.ts      # 反馈服务实现
```

## 未来扩展

1. **自动记录** - 与 sx-skill 集成，自动记录执行结果
2. **趋势分析** - 分析技能表现趋势
3. **智能建议** - 基于反馈数据提供更智能的更新建议
4. **反馈聚合** - 支持跨项目的反馈聚合分析
