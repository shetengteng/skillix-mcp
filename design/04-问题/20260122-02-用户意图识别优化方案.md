# 用户意图识别优化方案

> 文档日期：2026-01-22
> 问题：如何自动识别用户意图，知道用户的需求需要使用 Skill 而不是让模型直接处理？

## 一、问题分析

### 1.1 当前挑战

```
用户: "帮我处理这个 PDF 文件"

问题: AI 应该...
A) 直接处理（模型原生能力）
B) 使用 Skill（调用 pdf-converter 技能）
```

### 1.2 核心问题

1. **何时使用 Skill？** - 并非所有任务都需要 Skill
2. **如何匹配？** - 如何从用户自然语言中识别出对应的 Skill
3. **谁来决策？** - AI 还是系统自动决策

---

## 二、参考方案分析

### 2.1 SkillForge 的 Phase 0 分流方案

SkillForge 实现了智能分流系统：

```python
# 决策矩阵
匹配度 ≥80% + 显式创建请求 → CLARIFY (重复警告)
匹配度 ≥80% + 其他输入     → USE_EXISTING (推荐技能)
匹配度 50-79%             → IMPROVE_EXISTING (增强匹配)
匹配度 <50% + 显式创建    → CREATE_NEW (继续到 Phase 1)
检测到多领域              → COMPOSE (建议技能链)
输入模糊                  → CLARIFY (请求更多信息)
```

**关键技术**：
- 输入类型分类
- 领域同义词映射
- 匹配度计算
- 决策矩阵

### 2.2 Anthropic Skill-Creator 的方案

Skill-Creator 依赖 **description 字段** 进行匹配：

```yaml
name: pdf-converter
description: PDF 文件转换工具。当用户需要处理 PDF 文件、
            转换 PDF 格式、提取 PDF 内容时使用此技能。
```

**关键技术**：
- 清晰的触发场景描述
- 关键词匹配
- 渐进式披露

---

## 三、优化方案

### 3.1 方案一：增强 sx-dispatch 分流能力

**原理**：让 `sx-dispatch` 成为智能入口，自动分析用户输入并决策。

**实现**：

```typescript
// 增强的分流分析
interface DispatchAnalysis {
  // 输入分类
  inputType: 'explicit_skill' | 'task_request' | 'question' | 'general';
  
  // 匹配结果
  matches: {
    skill: string;
    score: number;        // 0-1 匹配度
    confidence: number;   // 置信度
    reason: string;       // 匹配原因
  }[];
  
  // 推荐操作
  action: 'USE_EXISTING' | 'CREATE_NEW' | 'NO_SKILL_NEEDED' | 'CLARIFY';
  
  // 决策依据
  reasoning: string;
}
```

**匹配算法**：

```typescript
function calculateMatchScore(query: string, skill: Skill): number {
  let score = 0;
  
  // 1. 名称匹配 (权重 0.2)
  if (query.includes(skill.name)) {
    score += 0.2;
  }
  
  // 2. 描述关键词匹配 (权重 0.4)
  const descKeywords = extractKeywords(skill.metadata.description);
  const queryKeywords = extractKeywords(query);
  const keywordOverlap = calculateOverlap(descKeywords, queryKeywords);
  score += keywordOverlap * 0.4;
  
  // 3. 标签匹配 (权重 0.2)
  const tagMatch = skill.metadata.tags?.some(tag => 
    query.toLowerCase().includes(tag.toLowerCase())
  );
  if (tagMatch) score += 0.2;
  
  // 4. 领域同义词匹配 (权重 0.2)
  const domainScore = matchDomainSynonyms(query, skill);
  score += domainScore * 0.2;
  
  return score;
}
```

**领域同义词映射**：

```typescript
const DOMAIN_SYNONYMS = {
  pdf: ['pdf', 'document', '文档', 'acrobat', '转换'],
  excel: ['excel', 'xlsx', 'spreadsheet', '表格', '电子表格'],
  image: ['image', 'picture', '图片', '图像', 'png', 'jpg'],
  code: ['code', 'coding', '代码', '编程', 'programming'],
  git: ['git', 'commit', '提交', 'repository', '仓库'],
  // ... 更多领域
};
```

### 3.2 方案二：优化 Skill Description

**原理**：让 Skill 的 description 更加"可发现"。

**当前问题**：

```yaml
# 不好的 description
description: PDF 转换工具

# 问题：
# - 没有说明触发场景
# - 关键词太少
# - AI 难以匹配
```

**优化后**：

```yaml
# 好的 description
description: |
  PDF 文件处理工具。
  触发场景：当用户需要处理 PDF 文件时使用，包括：
  - 转换 PDF 为其他格式（图片、文本、Markdown）
  - 合并或拆分 PDF 文件
  - 提取 PDF 中的文本或表格
  - 填写 PDF 表单
  关键词：PDF、文档、转换、提取、合并
```

**Description 规范**：

```markdown
## Description 编写规范

1. 第一句：简洁说明技能功能
2. 触发场景：明确列出使用场景
3. 关键词：包含可能的用户表达方式
4. 中英文：支持双语关键词

示例：
description: |
  [功能说明]
  触发场景：[场景列表]
  关键词：[关键词列表]
```

### 3.3 方案三：Cursor Rule 引导 AI 主动调用

**原理**：通过 Cursor Rule 指导 AI 在特定情况下主动调用 `sx-dispatch`。

**当前 Rule**：

```markdown
当用户提出任务需求时，遵循以下流程：
1. 分析任务：`sx-dispatch task="任务描述"`
```

**问题**：AI 可能忽略这个指引，直接处理任务。

**优化方案**：

```markdown
---
description: Skillix 智能分流规则
alwaysApply: true
---

# Skillix 使用规范

## 核心原则

**在处理任何任务之前**，先判断是否需要使用 Skill：

### 需要调用 sx-dispatch 的情况

1. 用户提到特定文件类型（PDF、Excel、图片等）
2. 用户描述的任务可能有现成解决方案
3. 用户使用"帮我"、"处理"、"转换"等动词
4. 任务涉及重复性工作

### 不需要调用的情况

1. 简单的问答对话
2. 代码编写（除非涉及特定框架/工具）
3. 用户明确说"直接处理"

## 决策流程

\`\`\`
用户输入
    ↓
判断是否为任务请求？
    ↓ 是
调用 sx-dispatch task="用户输入"
    ↓
根据返回的 action 执行
\`\`\`
```

### 3.4 方案四：混合方案（推荐）

**原理**：结合以上三种方案，形成完整的意图识别系统。

```
┌─────────────────────────────────────────────────────────────┐
│ 层级 1：Cursor Rule 引导                                     │
│ - 指导 AI 何时调用 sx-dispatch                               │
│ - 定义调用/不调用的场景                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 层级 2：sx-dispatch 智能分流                                 │
│ - 分析用户输入                                               │
│ - 匹配现有技能                                               │
│ - 返回推荐操作                                               │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 层级 3：Skill Description 匹配                               │
│ - 优化的 description 格式                                    │
│ - 领域同义词映射                                             │
│ - 多维度匹配算法                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、实现建议

### 4.1 短期优化（立即可做）

1. **优化 Cursor Rule**
   - 明确调用 sx-dispatch 的场景
   - 添加决策流程图

2. **优化 Skill Description 规范**
   - 定义标准格式
   - 要求包含触发场景和关键词

### 4.2 中期优化（需要开发）

1. **增强 sx-dispatch 分流能力**
   - 添加领域同义词映射
   - 优化匹配算法
   - 返回匹配置信度

2. **添加 sx-dispatch 自动调用机制**
   - 在 Tool Description 中添加触发提示
   - 让 AI 更容易识别何时需要调用

### 4.3 长期优化（需要研究）

1. **语义理解增强**
   - 使用嵌入向量进行语义匹配
   - 支持模糊匹配和意图推断

2. **学习机制**
   - 记录用户使用模式
   - 自动优化匹配权重

---

## 五、优化后的 sx-dispatch 设计

### 5.1 输入增强

```typescript
interface DispatchInput {
  task: string;           // 用户任务描述
  context?: string;       // 上下文信息
  hints?: string[];       // 提示词（可选）
  config?: {
    enableMarketSearch: boolean;  // 是否搜索市场
    minConfidence: number;        // 最低置信度阈值
  };
}
```

### 5.2 输出增强

```typescript
interface DispatchOutput {
  action: 'USE_EXISTING' | 'CREATE_NEW' | 'INSTALL' | 'NO_SKILL_NEEDED' | 'CLARIFY';
  
  // 匹配详情
  matchDetails?: {
    skill: string;
    score: number;
    confidence: number;
    matchedKeywords: string[];
    reason: string;
  }[];
  
  // 推荐技能
  skill?: string;
  source?: 'local' | 'market';
  
  // 决策说明
  reasoning: string;
  
  // 下一步建议
  nextSteps: string[];
}
```

### 5.3 匹配算法优化

```typescript
function analyzeTask(input: DispatchInput): DispatchOutput {
  const { task, hints, config } = input;
  
  // 1. 提取关键词
  const keywords = extractKeywords(task);
  
  // 2. 领域识别
  const domains = identifyDomains(keywords);
  
  // 3. 本地技能匹配
  const localMatches = matchLocalSkills(keywords, domains);
  
  // 4. 市场技能匹配（可选）
  let marketMatches = [];
  if (config?.enableMarketSearch && localMatches.length === 0) {
    marketMatches = matchMarketSkills(keywords, domains);
  }
  
  // 5. 决策
  const allMatches = [...localMatches, ...marketMatches];
  const bestMatch = allMatches[0];
  
  if (!bestMatch || bestMatch.score < 0.3) {
    return {
      action: 'CREATE_NEW',
      reasoning: '未找到匹配的技能，建议创建新技能',
      nextSteps: ['调用 sx-help topic=skill 获取创建指南'],
    };
  }
  
  if (bestMatch.score >= 0.7) {
    return {
      action: 'USE_EXISTING',
      skill: bestMatch.skill,
      matchDetails: allMatches,
      reasoning: `找到高度匹配的技能: ${bestMatch.skill}`,
      nextSteps: [`调用 sx-skill action=read name="${bestMatch.skill}"`],
    };
  }
  
  // 中等匹配，询问用户确认
  return {
    action: 'CLARIFY',
    matchDetails: allMatches,
    reasoning: '找到可能匹配的技能，需要确认',
    nextSteps: ['请确认是否使用以下技能'],
  };
}
```

---

## 六、总结

### 6.1 核心结论

| 问题 | 答案 |
|------|------|
| 谁来决策？ | AI 根据 Cursor Rule 指引决策 |
| 何时使用 Skill？ | 任务请求 + sx-dispatch 匹配成功 |
| 如何匹配？ | 关键词 + 领域同义词 + 语义相似度 |

### 6.2 推荐实施顺序

1. **优化 Cursor Rule** - 明确调用场景
2. **定义 Description 规范** - 提高可发现性
3. **增强 sx-dispatch** - 优化匹配算法
4. **添加领域同义词** - 支持多种表达方式

### 6.3 关键指标

| 指标 | 目标 |
|------|------|
| 匹配准确率 | ≥ 80% |
| 误报率 | ≤ 10% |
| 响应时间 | < 500ms |

### 6.4 Action 命名规范

`DispatchActionType` 使用 **SCREAMING_SNAKE_CASE**（全大写下划线分隔）命名：

```typescript
type DispatchActionType =
  | 'USE_EXISTING'      // 使用现有技能
  | 'IMPROVE_EXISTING'  // 改进现有技能
  | 'CREATE_NEW'        // 创建新技能
  | 'INSTALL'           // 从市场安装
  | 'COMPOSE'           // 组合多个技能
  | 'NO_SKILL_NEEDED';  // 无需技能
```

**为什么使用大写？**

| 原因 | 说明 |
|------|------|
| **行业惯例** | 枚举值/常量通常使用大写，如 HTTP 方法 (GET, POST)、Redux action types |
| **视觉区分** | 大写字符串在代码中更醒目，易于识别为"操作类型"而非普通字符串 |
| **AI 友好** | 大写格式在 AI 输出中更易于解析和匹配 |
| **一致性** | 与 SkillForge 等参考项目保持一致 |

**使用示例**：

```typescript
// 在 Cursor Rule 中
| action | 说明 | 下一步操作 |
|--------|------|-----------|
| USE_EXISTING | 使用现有技能 | `sx-skill action=read name="技能名"` |
| INSTALL | 从市场安装 | `sx-market action=install name="技能名"` |

// 在代码中判断
if (result.action === 'USE_EXISTING') {
  // 使用现有技能
}
```

---

## 七、实施进度（方案四：混合方案）

> 更新日期：2026-01-22

### 7.1 已完成项目

| 序号 | 任务 | 状态 | 修改文件 |
|------|------|------|----------|
| 1 | 优化 Cursor Rule | ✅ 完成 | `src/templates/skillix-rule.ts` |
| 2 | 添加领域同义词映射 | ✅ 完成 | `src/services/dispatch/synonyms.ts` |
| 3 | 优化匹配算法 | ✅ 完成 | `src/services/dispatch/matcher.ts` |
| 4 | 增强输出信息 | ✅ 完成 | `src/tools/dispatches/analyze.ts`, `src/services/types.ts` |
| 5 | 添加 Description 编写规范 | ✅ 完成 | `src/tools/helps/skill.ts` |
| 6 | 代码拆分重构 | ✅ 完成 | 拆分为 4 个模块文件 |
| 7 | 类型定义整合 | ✅ 完成 | 将 dispatch 类型移至 `src/services/types.ts` |
| 8 | 多语言同义词支持 | ✅ 完成 | 添加日语、韩语、法语、德语、西班牙语 |
| 9 | 多语言支持说明 | ✅ 完成 | 在文档中添加多语言支持讨论 |
| 10 | 运行测试验证 | ✅ 完成 | 所有 290 个测试通过 |

### 7.2 实现详情

#### 7.2.1 Cursor Rule 优化

优化了 `skillix-rule.ts`，明确了：
- 需要调用 sx-dispatch 的 6 种情况（文件处理、工具/框架、重复性工作等）
- 不需要调用的 4 种情况（简单问答、基础代码编写等）
- 添加了决策流程图

#### 7.2.2 代码拆分重构

将 `analyzer.ts` 拆分为 4 个模块：

```
src/services/dispatch/
├── index.ts        # 统一导出入口
├── analyzer.ts     # 主分析逻辑（精简后约 150 行）
├── types.ts        # 类型定义（AnalyzeParams, SkillInfo, MatchScoreDetails 等）
├── synonyms.ts     # 领域同义词映射（DOMAIN_SYNONYMS）
├── matcher.ts      # 匹配算法（calculateMatchScore 等）
└── collector.ts    # 技能收集器（collectLocalSkills, collectMarketSkills）
```

#### 7.2.3 领域同义词映射

在 `synonyms.ts` 中添加了 `DOMAIN_SYNONYMS` 常量，覆盖 25+ 个领域：
- 文档处理：pdf, excel, word, markdown
- 图像处理：image, screenshot
- 代码相关：code, refactor, test, debug
- 版本控制：git, github
- 容器化：docker, kubernetes
- 数据库：database, mysql, postgres, mongodb, redis
- API 相关：api, http
- 前端框架：react, vue, angular
- 后端框架：node, python, java
- 数据处理：json, xml, csv, yaml
- 文件操作：file, compress
- 网络相关：network, download, upload
- 安全相关：security, auth
- 自动化：automation, crawler
- 转换/生成：convert, format, generate, template

**多语言支持说明**：

当前同义词映射已支持 7 种主流语言：

| 语言 | 支持程度 | 示例关键词 |
|------|---------|-----------|
| 英文 | ✅ 完全支持 | pdf, document, image, code, test |
| 中文 | ✅ 完全支持 | 文档, 图片, 代码, 测试, 压缩 |
| 日语 | ✅ 完全支持 | ドキュメント, 画像, コード, テスト |
| 韩语 | ✅ 完全支持 | 문서, 이미지, 코드, 테스트 |
| 法语 | ✅ 完全支持 | document, image, code, test |
| 德语 | ✅ 完全支持 | dokument, bild, code, test |
| 西班牙语 | ✅ 完全支持 | documento, imagen, código, prueba |

**示例**：

```typescript
// PDF 领域的多语言支持
pdf: [
  // 英文
  'pdf', 'document', 'acrobat',
  // 中文
  '文档', 'PDF文件',
  // 日语
  'ドキュメント', 'PDF文書', '書類',
  // 韩语
  '문서', 'PDF파일',
  // 法语
  'fichier pdf', 'document pdf',
  // 德语
  'dokument', 'pdf-datei',
  // 西班牙语
  'documento', 'archivo pdf',
]
```

**扩展其他语言**：

如需支持其他语言，可以在 `synonyms.ts` 中扩展 `DOMAIN_SYNONYMS` 常量。

**注意事项**：
- 同义词匹配采用字符串包含检查，对大多数语言有效
- 对于需要分词的语言（如日语），当前简单匹配可能效果有限
- 建议为目标用户群体的主要语言添加常用同义词

#### 7.2.4 多维度匹配算法

实现了新的匹配算法，权重分配：
- 名称匹配：30%（支持连字符和空格等价匹配）
- 描述关键词匹配：35%
- 标签匹配：15%
- 领域同义词匹配：20%

#### 7.2.5 增强输出信息

`sx-dispatch` 返回的 `availableSkills` 现在包含：
- `relevanceScore`: 总匹配分数
- `scoreDetails`: 详细分数（nameScore, descriptionScore, tagScore, domainScore）
- `matchedKeywords`: 匹配的关键词列表
- `matchedDomains`: 匹配的领域列表

#### 7.2.6 Description 编写规范

在 `sx-help topic=skill` 中添加了详细的 Description 编写规范：
- 规范结构（功能说明 + 触发场景 + 关键词）
- 好的/不好的示例
- 编写要点表格
- 领域关键词参考表

### 7.3 测试结果

```
Test Files  15 passed (15)
Tests       290 passed | 3 skipped (293)
Duration    3.33s
```

所有测试通过，包括新增的匹配算法相关测试。
