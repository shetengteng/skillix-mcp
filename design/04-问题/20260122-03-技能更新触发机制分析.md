# 技能更新触发机制分析

> 文档日期：2026-01-22
> 问题：AI 如何知道什么情况下应该更新 Skill？

## 一、问题分析

### 1.1 核心问题

```
用户: "帮我处理这个 PDF 文件"
AI: [使用 pdf-converter 技能执行任务]
AI: [任务完成，但发现技能指令有些过时]

问题: AI 应该如何判断是否需要更新技能？
```

### 1.2 当前实现

当前系统通过 `sx-dispatch` 返回 `IMPROVE_EXISTING` action 来建议更新技能：

```typescript
// 当前 analyzer.ts 中的判断逻辑
if (bestMatch && bestScore >= 0.3 && bestMatch.scope !== 'market') {
  return {
    action: 'IMPROVE_EXISTING',
    skill: bestMatch.name,
    confidence: bestScore,
    reason: `找到部分匹配的技能 "${bestMatch.name}"（匹配度: ${(bestScore * 100).toFixed(0)}%），可能需要改进以满足需求`,
  };
}
```

### 1.3 当前不足

| 问题 | 说明 |
|------|------|
| **被动触发** | 只有在匹配度较低时才建议更新，无法主动检测技能过时 |
| **缺乏反馈机制** | 没有记录技能使用结果，无法基于历史数据判断 |
| **无版本检测** | 不会检查技能是否有新版本可用 |
| **无失败检测** | 技能执行失败后不会自动建议更新 |

---

## 二、触发更新的场景

### 2.1 应该触发更新的情况

| 场景 | 触发条件 | 优先级 |
|------|---------|--------|
| **执行失败** | 技能指令执行出错或失败 | 高 |
| **部分匹配** | 任务需求与技能功能部分匹配 | 中 |
| **用户反馈** | 用户明确表示技能需要改进 | 高 |
| **版本过时** | 市场有更新版本的技能 | 低 |
| **多次失败** | 同一技能多次执行失败 | 高 |
| **功能缺失** | 技能缺少用户需要的功能 | 中 |

### 2.2 不应该触发更新的情况

| 场景 | 说明 |
|------|------|
| **执行成功** | 技能正常完成任务 |
| **用户满意** | 用户对结果满意 |
| **首次使用** | 首次使用技能，应先完整执行 |
| **临时需求** | 一次性需求，不值得更新技能 |

---

## 三、当前实现详情

### 3.1 IMPROVE_EXISTING 触发逻辑

```typescript
// src/services/dispatch/analyzer.ts

// 低分匹配 (>= 0.3) - 可能需要改进现有技能
if (bestMatch && bestScore >= 0.3 && bestMatch.scope !== 'market') {
  return {
    action: 'IMPROVE_EXISTING',
    skill: bestMatch.name,
    source: bestMatch.source,
    confidence: bestScore,
    reason: `找到部分匹配的技能 "${bestMatch.name}"（匹配度: ${(bestScore * 100).toFixed(0)}%），可能需要改进以满足需求`,
    matchDetails,
  };
}
```

**触发条件**：
- 匹配分数在 0.3 - 0.5 之间
- 技能是本地技能（非市场技能）

### 3.2 Cursor Rule 中的更新指引

```markdown
| action | 说明 | 下一步操作 |
|--------|------|-----------|
| IMPROVE_EXISTING | 改进现有技能 | 先读取再更新技能 |
```

### 3.3 更新工具实现

```typescript
// src/tools/skills/update.ts
export function handleUpdate(params: SxSkillParams): ToolResponse {
  const { name, projectRoot, metadata, body } = params;
  
  // 验证参数
  if (!name) {
    return error({ message: '缺少技能名称' });
  }
  
  if (!metadata && body === undefined) {
    return error({ message: '缺少更新内容' });
  }
  
  // 执行更新（自动创建备份）
  const skill = skillService.updateSkill(name, { metadata, body }, projectRoot);
  // ...
}
```

---

## 四、优化方案

### 4.1 方案一：增强 sx-dispatch 判断逻辑

**原理**：在 dispatch 分析时，增加更多判断维度。

```typescript
// 增强的判断逻辑
interface EnhancedDispatchResult {
  action: DispatchActionType;
  // 新增：更新建议
  updateSuggestion?: {
    reason: 'partial_match' | 'outdated' | 'missing_feature' | 'user_feedback';
    confidence: number;
    suggestedChanges?: string[];
  };
}
```

**优点**：
- 在任务分析阶段就能判断是否需要更新
- 可以提供具体的更新建议

**缺点**：
- 无法检测执行失败的情况
- 依赖静态分析，可能不准确

### 4.2 方案二：添加反馈机制

**原理**：记录技能使用结果，基于历史数据判断。

```typescript
// 反馈记录
interface SkillFeedback {
  skillName: string;
  task: string;
  result: 'success' | 'failure' | 'partial';
  timestamp: string;
  notes?: string;
}

// 反馈分析
function analyzeSkillFeedback(skillName: string): {
  shouldUpdate: boolean;
  reason: string;
  confidence: number;
} {
  const feedbacks = loadFeedbacks(skillName);
  const recentFailures = feedbacks.filter(f => 
    f.result === 'failure' && 
    isRecent(f.timestamp)
  );
  
  if (recentFailures.length >= 3) {
    return {
      shouldUpdate: true,
      reason: '近期多次执行失败',
      confidence: 0.8,
    };
  }
  // ...
}
```

**优点**：
- 基于实际使用数据判断
- 可以检测执行失败的情况

**缺点**：
- 需要用户主动记录反馈
- 需要累积足够数据才能判断

### 4.3 方案三：Cursor Rule 引导 AI 主动判断（推荐）

**原理**：通过 Cursor Rule 指导 AI 在特定情况下主动建议更新。

```markdown
# 技能更新判断规则

## 应该建议更新的情况

1. **执行失败**
   - 技能指令执行出错
   - 依赖的工具/API 已变更
   - 输出格式不符合预期

2. **功能不足**
   - 用户需要的功能技能没有
   - 技能只能部分完成任务
   - 需要额外步骤补充

3. **用户反馈**
   - 用户说"这个技能不太好用"
   - 用户说"能不能改进一下"
   - 用户提出具体改进建议

## 更新流程

1. 读取现有技能：`sx-skill action=read name="技能名"`
2. 分析问题所在
3. 生成改进方案
4. 询问用户确认
5. 执行更新：`sx-skill action=update name="技能名" metadata={...} body="..."`
```

**优点**：
- 利用 AI 的理解能力判断
- 灵活适应各种情况
- 无需额外开发

**缺点**：
- 依赖 AI 遵循规则
- 可能判断不一致

### 4.4 方案四：混合方案

**原理**：结合以上方案，形成完整的更新触发机制。

```
┌─────────────────────────────────────────────────────────────┐
│ 层级 1：Cursor Rule 引导                                     │
│ - 指导 AI 何时建议更新                                       │
│ - 定义更新触发条件                                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 层级 2：sx-dispatch 分析                                     │
│ - 返回 IMPROVE_EXISTING 建议                                 │
│ - 提供匹配度和更新原因                                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 层级 3：反馈机制（可选）                                     │
│ - 记录使用结果                                               │
│ - 基于历史数据判断                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、推荐实施

### 5.1 短期优化（立即可做）

1. **优化 Cursor Rule**
   - 添加技能更新判断规则
   - 明确更新触发条件
   - 提供更新流程指引

2. **优化 IMPROVE_EXISTING 返回信息**
   - 添加具体的更新建议
   - 说明为什么建议更新

### 5.2 中期优化（需要开发）

1. **添加反馈记录功能**
   - 实现 `sx-feedback` 工具
   - 记录技能使用结果

2. **增强 sx-dispatch 分析**
   - 检查技能版本
   - 分析历史反馈

### 5.3 长期优化（需要研究）

1. **自动检测技能过时**
   - 检查依赖是否更新
   - 检查 API 是否变更

2. **智能更新建议**
   - 基于使用模式推荐更新
   - 自动生成更新内容

---

## 六、优化后的 Cursor Rule

```markdown
# 技能更新判断规则

## 何时建议更新技能

### 高优先级（应该立即建议）

1. **执行失败**
   - 技能指令执行报错
   - 依赖工具不存在或版本不兼容
   - 输出结果明显错误

2. **用户明确要求**
   - 用户说"更新一下这个技能"
   - 用户说"这个技能有问题"
   - 用户提出具体改进建议

### 中优先级（可以询问用户）

1. **功能不完整**
   - 技能只能完成部分任务
   - 需要额外步骤补充
   - 缺少用户需要的功能

2. **sx-dispatch 返回 IMPROVE_EXISTING**
   - 匹配度在 30%-50% 之间
   - 系统建议改进现有技能

### 低优先级（可以提醒用户）

1. **技能较旧**
   - 技能长时间未更新
   - 市场有更新版本

2. **多次部分成功**
   - 技能多次只能部分完成任务

## 更新流程

\`\`\`
1. 读取技能：sx-skill action=read name="技能名"
2. 分析问题：确定需要更新的内容
3. 询问确认：向用户说明更新内容
4. 执行更新：sx-skill action=update name="技能名" ...
5. 验证结果：确认更新是否解决问题
\`\`\`

## 更新内容建议

| 问题类型 | 建议更新内容 |
|---------|-------------|
| 指令过时 | 更新 body 中的具体指令 |
| 功能缺失 | 添加新的功能说明 |
| 描述不清 | 优化 description 和触发场景 |
| 依赖变更 | 更新依赖说明和版本要求 |
```

---

## 七、总结

### 7.1 核心结论

| 问题 | 答案 |
|------|------|
| AI 如何知道要更新？ | 通过 Cursor Rule 指引 + sx-dispatch 分析 |
| 什么情况触发更新？ | 执行失败、功能不足、用户反馈、匹配度低 |
| 如何执行更新？ | 先读取、分析问题、询问确认、执行更新 |

### 7.2 当前实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| IMPROVE_EXISTING action | ✅ 已实现 | 匹配度 30%-50% 时触发 |
| sx-skill update 工具 | ✅ 已实现 | 支持更新 metadata 和 body |
| 版本备份 | ✅ 已实现 | 更新时自动创建备份 |
| 进化日志 | ✅ 已实现 | 记录更新历史 |
| Cursor Rule 更新指引 | ⚠️ 待优化 | 需要添加详细的更新判断规则 |
| 反馈机制 | ❌ 未实现 | 设计文档中有，但未开发 |

### 7.3 推荐下一步

1. **优化 Cursor Rule** - 添加技能更新判断规则（短期）
2. **增强 IMPROVE_EXISTING 返回信息** - 提供更具体的更新建议（短期）
3. **实现反馈机制** - 开发 sx-feedback 工具（中期）
