# Skillix MCP Server 测试计划

## 概述

本文档描述 Skillix MCP Server 的测试策略，包括单元测试和端到端测试。

### 测试目标

1. **功能正确性**: 确保所有核心功能按预期工作
2. **边界情况处理**: 验证参数验证和错误处理
3. **隔离性**: 测试使用独立目录 `~/.skillix-test`，避免影响用户环境
4. **覆盖率**: 目标达到 80% 以上代码覆盖率

### 测试环境

- **测试框架**: Vitest
- **测试目录**: `~/.skillix-test` (全局) / `.skillix-test` (项目)
- **运行命令**: 
  - `npm test` - 监视模式
  - `npm run test:run` - 单次运行
  - `npm run test:coverage` - 覆盖率报告

---

## 测试分类

### 1. 单元测试 (Unit Tests)

#### 1.1 工具函数测试 (`tests/utils/`)

| 文件 | 测试内容 | 优先级 |
|------|----------|--------|
| `fs.test.ts` | 文件系统操作 (读写、复制、删除) | 高 |
| `markdown.test.ts` | Markdown 解析 (frontmatter、章节) | 高 |
| `paths.test.ts` | 路径工具函数 | 高 |
| `validation.test.ts` | 参数验证 (技能名称、描述) | 高 |

#### 1.2 服务层测试 (`tests/services/`)

| 文件 | 测试内容 | 优先级 |
|------|----------|--------|
| `skill.test.ts` | 技能 CRUD 操作 | 高 |
| `config.test.ts` | 配置管理 (全局/项目) | 高 |
| `dispatch.test.ts` | 任务分流分析 | 中 |
| `market.test.ts` | 市场搜索、安装 | 中 |

#### 1.3 工具层测试 (`tests/tools/`)

| 文件 | 测试内容 | 优先级 |
|------|----------|--------|
| `skills.test.ts` | sx-skill 工具所有操作 | 高 |
| `configs.test.ts` | sx-config 工具所有操作 | 高 |
| `helps.test.ts` | sx-help 工具输出 | 低 |
| `dispatches.test.ts` | sx-dispatch 工具 | 中 |
| `markets.test.ts` | sx-market 工具 | 中 |

### 2. 端到端测试 (E2E Tests)

#### 2.1 完整工作流测试 (`tests/e2e/`)

| 场景 | 描述 |
|------|------|
| 技能生命周期 | 创建 → 读取 → 更新 → 删除 |
| 配置工作流 | 初始化 → 设置 → 读取 |
| 项目级技能 | 项目初始化 → 创建项目技能 → 列表 |

---

## 测试用例详情

### Utils 测试

#### fs.test.ts
```typescript
describe('fs utils', () => {
  // 文件操作
  - exists(): 检查存在/不存在的文件
  - isDirectory(): 检查目录/文件
  - isFile(): 检查文件/目录
  - readFile(): 读取文件内容
  - writeFile(): 写入文件（含自动创建目录）
  
  // JSON 操作
  - readJson(): 读取 JSON 文件
  - writeJson(): 写入 JSON 文件
  
  // 目录操作
  - ensureDir(): 创建目录（递归）
  - listDir(): 列出目录内容
  - listSubDirs(): 列出子目录
  
  // 删除操作
  - removeFile(): 删除文件
  - removeDir(): 删除目录（递归）
  
  // 复制操作
  - copyFile(): 复制文件
  - copyDir(): 复制目录（递归）
})
```

#### markdown.test.ts
```typescript
describe('markdown utils', () => {
  // Frontmatter 解析
  - parseFrontmatter(): 解析 YAML frontmatter
  - parseFrontmatter(): 处理无 frontmatter 的内容
  - parseFrontmatter(): 处理数组类型的值
  
  // 技能相关
  - parseSkillMetadata(): 解析技能元数据
  - getSkillBody(): 获取正文内容
  - generateSkillMd(): 生成 SKILL.md
  
  // 章节提取
  - extractTitle(): 提取标题
  - extractSections(): 提取所有章节
})
```

#### paths.test.ts
```typescript
describe('paths utils', () => {
  // 全局路径
  - getGlobalDir(): 返回 ~/.skillix
  - getGlobalConfigPath(): 返回配置路径
  - getGlobalSkillsDir(): 返回技能目录
  
  // 项目路径
  - getProjectDir(): 返回 .skillix 路径
  - getProjectConfigPath(): 返回项目配置路径
  - getProjectSkillsDir(): 返回项目技能目录
  
  // 技能路径
  - getSkillDir(): 返回技能目录路径
  - getSkillMdPath(): 返回 SKILL.md 路径
  - getSkillScriptsDir(): 返回 scripts 目录路径
})
```

#### validation.test.ts
```typescript
describe('validation utils', () => {
  // 名称验证
  - validateSkillName(): 有效名称
  - validateSkillName(): 空名称
  - validateSkillName(): 太短/太长
  - validateSkillName(): 保留词
  - validateSkillName(): 大写字母
  - validateSkillName(): 下划线
  - validateSkillName(): 连续连字符
  
  // 描述验证
  - validateSkillDescription(): 有效描述
  - validateSkillDescription(): 空描述
  - validateSkillDescription(): 太长
  - validateSkillDescription(): 包含尖括号
  - validateSkillDescription(): 词数不足
  
  // 配置验证
  - isValidGlobalConfigKey(): 有效/无效键
  - validateConfigValue(): 各种配置值
})
```

### Services 测试

#### skill.test.ts
```typescript
describe('skill service', () => {
  // 创建
  - createSkill(): 创建全局技能
  - createSkill(): 创建项目技能
  
  // 列表
  - listGlobalSkills(): 列出全局技能
  - listProjectSkills(): 列出项目技能
  - listAllSkills(): 列出所有技能
  
  // 读取
  - getSkill(): 获取存在的技能
  - getSkill(): 获取不存在的技能
  - readSkillContent(): 读取技能内容
  
  // 更新
  - updateSkill(): 更新元数据
  - updateSkill(): 更新正文
  
  // 删除
  - deleteSkill(): 删除存在的技能
  - deleteSkill(): 删除不存在的技能
  
  // 检查
  - skillExists(): 技能存在
  - skillExists(): 技能不存在
})
```

#### config.test.ts
```typescript
describe('config service', () => {
  // 全局配置
  - getGlobalConfig(): 获取默认配置
  - getGlobalConfig(): 获取存在的配置
  - saveGlobalConfig(): 保存配置
  
  // 项目配置
  - getProjectConfig(): 获取项目配置
  - saveProjectConfig(): 保存项目配置
  - initProject(): 初始化项目
  
  // 配置合并
  - getEffectiveConfig(): 合并全局和项目配置
  
  // 技能源
  - addSource(): 添加技能源
  - removeSource(): 移除技能源
  - listSources(): 列出技能源
})
```

### E2E 测试

#### workflow.test.ts
```typescript
describe('E2E Workflow', () => {
  // 技能完整生命周期
  describe('skill lifecycle', () => {
    - 创建技能
    - 读取技能
    - 更新技能
    - 列出技能
    - 删除技能
    - 验证删除成功
  })
  
  // 配置工作流
  describe('config workflow', () => {
    - 初始化项目
    - 设置配置
    - 读取配置
  })
  
  // 多技能场景
  describe('multiple skills', () => {
    - 创建多个技能
    - 按名称搜索
    - 批量操作
  })
})
```

---

## 测试 Fixtures

### 技能 Fixtures (`tests/fixtures/skills.ts`)

```typescript
// 测试用技能数据
export const TEST_SKILL = {
  name: 'test-skill',
  metadata: {
    name: 'test-skill',
    description: 'A test skill for unit testing',
    version: '1.0.0',
    author: 'test',
    tags: ['test', 'unit'],
  },
  body: '# Test Skill\n\nThis is a test skill.',
};

export const SKILL_MD_CONTENT = `---
name: test-skill
description: A test skill for unit testing
version: 1.0.0
author: test
tags:
  - test
  - unit
---

# Test Skill

This is a test skill.
`;
```

### 测试辅助函数 (`tests/helpers/setup.ts`)

```typescript
// 测试环境设置
export const TEST_BASE_DIR = join(homedir(), '.skillix-test');
export const TEST_PROJECT_DIR = join(process.cwd(), '.skillix-test');

export async function setupTestEnv() {
  // 清理并创建测试目录
}

export async function cleanupTestEnv() {
  // 清理测试目录
}

// Mock paths 返回测试目录
export function mockPaths() {
  // 重写路径函数使用测试目录
}
```

---

## 运行测试

### 命令

```bash
# 运行所有测试
npm test

# 运行指定文件
npm test -- tests/utils/fs.test.ts

# 运行指定模式
npm test -- --grep "skill"

# 生成覆盖率报告
npm run test:coverage
```

### CI 集成

GitHub Actions 工作流将在每次推送时运行测试。

---

## 注意事项

1. **测试隔离**: 所有测试使用 `~/.skillix-test` 目录，测试完成后自动清理
2. **并行执行**: 单元测试可以并行执行，E2E 测试需要串行
3. **Mock 策略**: 路径函数需要 mock 到测试目录
4. **超时设置**: E2E 测试可能需要更长的超时时间
