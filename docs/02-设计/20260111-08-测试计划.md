# Skillix 测试计划

> 日期: 2026-01-11
> 状态: 草案

---

## 一、测试策略概览

### 1.1 测试层次

```
┌─────────────────────────────────────────────────────────┐
│                    E2E 测试 (端到端)                      │
│              验证完整的 MCP 工具调用流程                    │
├─────────────────────────────────────────────────────────┤
│                    集成测试                               │
│           验证服务层与工具层的协作                          │
├─────────────────────────────────────────────────────────┤
│                    单元测试                               │
│        验证各个模块的独立功能                              │
└─────────────────────────────────────────────────────────┘
```

### 1.2 测试框架选型

| 框架 | 用途 | 说明 |
|------|------|------|
| **Vitest** | 单元测试 + 集成测试 | 快速、TypeScript 原生支持 |
| **@modelcontextprotocol/sdk** | MCP 测试 | 模拟 MCP 客户端 |

---

## 二、单元测试计划

### 2.1 工具函数测试 (`src/utils/`)

#### fs.ts 测试

```typescript
describe('fs utils', () => {
  describe('exists', () => {
    it('should return true for existing file');
    it('should return false for non-existing file');
  });

  describe('readFile', () => {
    it('should read file content');
    it('should return empty string for non-existing file');
  });

  describe('writeFile', () => {
    it('should write content to file');
    it('should create parent directories if not exist');
  });

  describe('readJson', () => {
    it('should parse JSON file');
    it('should return null for invalid JSON');
  });

  describe('writeJson', () => {
    it('should write JSON with formatting');
  });

  describe('ensureDir', () => {
    it('should create directory recursively');
    it('should not throw if directory exists');
  });

  describe('removeDir', () => {
    it('should remove directory recursively');
    it('should return false for non-existing directory');
  });

  describe('listDir', () => {
    it('should list directory contents');
    it('should return empty array for non-existing directory');
  });

  describe('listSubDirs', () => {
    it('should list only subdirectories');
    it('should exclude files');
  });
});
```

#### paths.ts 测试

```typescript
describe('paths utils', () => {
  describe('getGlobalDir', () => {
    it('should return ~/.skillix path');
  });

  describe('getGlobalConfigPath', () => {
    it('should return ~/.skillix/config.json path');
  });

  describe('getGlobalSkillsDir', () => {
    it('should return ~/.skillix/skills path');
  });

  describe('getProjectDir', () => {
    it('should return {projectRoot}/.skillix path');
  });

  describe('getProjectConfigPath', () => {
    it('should return {projectRoot}/.skillix/config.json path');
  });

  describe('getProjectSkillsDir', () => {
    it('should return {projectRoot}/.skillix/skills path');
  });

  describe('getSkillDir', () => {
    it('should return {skillsDir}/{skillName} path');
  });

  describe('getSkillMdPath', () => {
    it('should return {skillDir}/SKILL.md path');
  });

  describe('getSkillScriptsDir', () => {
    it('should return {skillDir}/scripts path');
  });

  describe('getSkillReferencesDir', () => {
    it('should return {skillDir}/references path');
  });

  describe('getSkillAssetsDir', () => {
    it('should return {skillDir}/assets path');
  });

  describe('getSkillLogsDir', () => {
    it('should return {skillDir}/logs path');
  });
});
```

#### markdown.ts 测试

```typescript
describe('markdown utils', () => {
  describe('parseFrontmatter', () => {
    it('should parse YAML frontmatter');
    it('should return empty metadata for no frontmatter');
    it('should handle invalid YAML gracefully');
  });

  describe('parseSkillMetadata', () => {
    it('should extract skill metadata from SKILL.md');
    it('should provide default values for missing fields');
  });

  describe('generateSkillMd', () => {
    it('should generate valid SKILL.md content');
    it('should include all metadata fields');
    it('should handle optional fields');
  });
});
```

### 2.2 服务层测试 (`src/services/`)

#### skill.ts 测试

```typescript
describe('skill service', () => {
  describe('listGlobalSkills', () => {
    it('should list all global skills');
    it('should return empty array if no skills');
  });

  describe('listProjectSkills', () => {
    it('should list all project skills');
    it('should return empty array if no project skills');
  });

  describe('listAllSkills', () => {
    it('should combine global and project skills');
    it('should work without projectRoot');
  });

  describe('getSkill', () => {
    it('should find project skill first (local priority)');
    it('should fallback to global skill');
    it('should return null if skill not found');
  });

  describe('readSkillContent', () => {
    it('should return metadata and body');
    it('should include scripts/references/assets lists');
    it('should return null if skill not found');
  });

  describe('createSkill', () => {
    it('should create skill directory structure');
    it('should create SKILL.md with metadata');
    it('should create global skill by default');
    it('should create project skill when specified');
  });

  describe('updateSkill', () => {
    it('should update metadata');
    it('should update body');
    it('should preserve unchanged fields');
    it('should return null if skill not found');
  });

  describe('deleteSkill', () => {
    it('should remove skill directory');
    it('should return false if skill not found');
  });

  describe('skillExists', () => {
    it('should return true for existing skill');
    it('should return false for non-existing skill');
  });

  describe('searchSkills', () => {
    it('should search by name');
    it('should search by description');
    it('should be case-insensitive');
  });
});
```

#### config.ts 测试

```typescript
describe('config service', () => {
  describe('getGlobalConfig', () => {
    it('should return global config');
    it('should return default config if not exists');
    it('should merge with default values');
  });

  describe('saveGlobalConfig', () => {
    it('should save config to file');
    it('should create directory if not exists');
  });

  describe('getProjectConfig', () => {
    it('should return project config');
    it('should return null if not exists');
  });

  describe('saveProjectConfig', () => {
    it('should save config to project directory');
  });

  describe('initProjectConfig', () => {
    it('should create .skillix directory');
    it('should create config.json');
    it('should create skills directory');
  });

  describe('getEffectiveConfig', () => {
    it('should use project config when available');
    it('should fallback to global config');
    it('should implement local priority strategy');
  });

  describe('addSource', () => {
    it('should add source to global config');
    it('should add source to project config');
    it('should update existing source');
  });

  describe('removeSource', () => {
    it('should remove source from global config');
    it('should remove source from project config');
    it('should return false if source not found');
  });

  describe('getAllSources', () => {
    it('should return effective sources');
  });
});
```

### 2.3 工具层测试 (`src/tools/`)

#### skills/ 测试

```typescript
describe('sx_skill tool', () => {
  describe('handleList', () => {
    it('should return list of skills');
    it('should include global and project skills');
  });

  describe('handleRead', () => {
    it('should return skill content');
    it('should return error if name missing');
    it('should return error if skill not found');
  });

  describe('handleCreate', () => {
    it('should create new skill');
    it('should return error if name missing');
    it('should return error if metadata missing');
    it('should return error if skill exists');
  });

  describe('handleUpdate', () => {
    it('should update existing skill');
    it('should return error if name missing');
    it('should return error if no updates provided');
    it('should return error if skill not found');
  });

  describe('handleDelete', () => {
    it('should delete skill');
    it('should return error if name missing');
    it('should return error if skill not found');
  });

  describe('sxSkill', () => {
    it('should route to correct handler');
    it('should return error for unknown action');
  });
});
```

#### configs/ 测试

```typescript
describe('sx_config tool', () => {
  describe('handleGet', () => {
    it('should return global config');
    it('should return project config');
    it('should return specific key');
  });

  describe('handleSet', () => {
    it('should set global config');
    it('should set project config');
    it('should return error if key missing');
    it('should return error if value missing');
  });

  describe('handleInit', () => {
    it('should initialize project config');
    it('should return error if projectRoot missing');
    it('should warn if config exists');
  });

  describe('handleSources', () => {
    it('should list sources');
    it('should add source');
    it('should remove source');
  });

  describe('sxConfig', () => {
    it('should route to correct handler');
    it('should return error for unknown action');
  });
});
```

#### helps/ 测试

```typescript
describe('sx_help tool', () => {
  describe('sxHelp', () => {
    it('should return overview help by default');
    it('should return skill help');
    it('should return config help');
    it('should return all help');
    it('should return error for unknown topic');
  });
});
```

---

## 三、集成测试计划

### 3.1 技能生命周期测试

```typescript
describe('skill lifecycle', () => {
  it('should create, read, update, and delete skill', async () => {
    // 1. 创建技能
    const createResult = await sxSkill({
      action: 'create',
      name: 'test-skill',
      metadata: { name: 'test-skill', description: 'Test' },
      body: '# Test Skill',
      scope: 'global',
    });
    expect(createResult.success).toBe(true);

    // 2. 读取技能
    const readResult = await sxSkill({
      action: 'read',
      name: 'test-skill',
    });
    expect(readResult.success).toBe(true);
    expect(readResult.data.metadata.name).toBe('test-skill');

    // 3. 更新技能
    const updateResult = await sxSkill({
      action: 'update',
      name: 'test-skill',
      metadata: { description: 'Updated' },
    });
    expect(updateResult.success).toBe(true);

    // 4. 删除技能
    const deleteResult = await sxSkill({
      action: 'delete',
      name: 'test-skill',
    });
    expect(deleteResult.success).toBe(true);

    // 5. 验证删除
    const verifyResult = await sxSkill({
      action: 'read',
      name: 'test-skill',
    });
    expect(verifyResult.success).toBe(false);
  });
});
```

### 3.2 配置管理测试

```typescript
describe('config management', () => {
  it('should initialize and manage project config', async () => {
    const projectRoot = '/tmp/test-project';

    // 1. 初始化项目
    const initResult = await sxConfig({
      action: 'init',
      projectRoot,
    });
    expect(initResult.success).toBe(true);

    // 2. 设置配置
    const setResult = await sxConfig({
      action: 'set',
      scope: 'project',
      projectRoot,
      key: 'format',
      value: 'json',
    });
    expect(setResult.success).toBe(true);

    // 3. 获取配置
    const getResult = await sxConfig({
      action: 'get',
      scope: 'project',
      projectRoot,
      key: 'format',
    });
    expect(getResult.data.format).toBe('json');
  });
});
```

### 3.3 本地优先策略测试

```typescript
describe('local priority strategy', () => {
  it('should prefer project skill over global skill', async () => {
    // 1. 创建全局技能
    await sxSkill({
      action: 'create',
      name: 'shared-skill',
      metadata: { name: 'shared-skill', description: 'Global version' },
      body: '# Global',
      scope: 'global',
    });

    // 2. 创建同名项目技能
    await sxSkill({
      action: 'create',
      name: 'shared-skill',
      metadata: { name: 'shared-skill', description: 'Project version' },
      body: '# Project',
      scope: 'project',
      projectRoot: '/tmp/test-project',
    });

    // 3. 读取技能（应返回项目版本）
    const result = await sxSkill({
      action: 'read',
      name: 'shared-skill',
      projectRoot: '/tmp/test-project',
    });
    expect(result.data.metadata.description).toBe('Project version');
  });
});
```

---

## 四、E2E 测试计划

### 4.1 MCP 协议测试

```typescript
describe('MCP protocol', () => {
  let client: MCPClient;

  beforeAll(async () => {
    client = await createMCPClient();
  });

  describe('list_tools', () => {
    it('should return all available tools', async () => {
      const tools = await client.listTools();
      expect(tools).toContainEqual(
        expect.objectContaining({ name: 'sx_skill' })
      );
      expect(tools).toContainEqual(
        expect.objectContaining({ name: 'sx_config' })
      );
      expect(tools).toContainEqual(
        expect.objectContaining({ name: 'sx_help' })
      );
    });
  });

  describe('call_tool', () => {
    it('should call sx_skill list', async () => {
      const result = await client.callTool('sx_skill', { action: 'list' });
      expect(result.success).toBe(true);
    });

    it('should call sx_config get', async () => {
      const result = await client.callTool('sx_config', { action: 'get' });
      expect(result.success).toBe(true);
    });

    it('should call sx_help', async () => {
      const result = await client.callTool('sx_help', { topic: 'overview' });
      expect(result.success).toBe(true);
    });

    it('should return error for unknown tool', async () => {
      const result = await client.callTool('unknown_tool', {});
      expect(result.success).toBe(false);
    });
  });
});
```

---

## 五、测试数据准备

### 5.1 测试夹具 (Fixtures)

```typescript
// tests/fixtures/skills.ts
export const TEST_SKILL_METADATA = {
  name: 'test-skill',
  description: 'A test skill for unit testing',
  version: '1.0.0',
  author: 'test',
  tags: ['test', 'unit'],
};

export const TEST_SKILL_BODY = `
# Test Skill

## Usage

This is a test skill.

## Example

\`\`\`bash
echo "Hello, World!"
\`\`\`
`;

export const TEST_SKILL_MD = `---
name: test-skill
description: A test skill for unit testing
version: 1.0.0
author: test
tags: [test, unit]
---

# Test Skill

## Usage

This is a test skill.
`;
```

### 5.2 测试工具函数

```typescript
// tests/helpers/setup.ts
import * as fs from 'node:fs';
import * as path from 'node:path';
import * as os from 'node:os';

export function createTempDir(): string {
  return fs.mkdtempSync(path.join(os.tmpdir(), 'skillix-test-'));
}

export function cleanupTempDir(dir: string): void {
  fs.rmSync(dir, { recursive: true, force: true });
}

export function createTestSkill(skillsDir: string, name: string, content: string): void {
  const skillDir = path.join(skillsDir, name);
  fs.mkdirSync(skillDir, { recursive: true });
  fs.writeFileSync(path.join(skillDir, 'SKILL.md'), content);
}
```

---

## 六、测试覆盖率目标

| 模块 | 目标覆盖率 | 说明 |
|------|-----------|------|
| `src/utils/` | 90%+ | 核心工具函数 |
| `src/services/` | 85%+ | 业务逻辑 |
| `src/tools/` | 80%+ | 工具处理器 |
| `src/index.ts` | 70%+ | MCP Server 入口 |
| **总体** | **80%+** | 整体覆盖率 |

---

## 七、测试执行计划

### 7.1 本地测试

```bash
# 运行所有测试
npm test

# 运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 运行 E2E 测试
npm run test:e2e

# 生成覆盖率报告
npm run test:coverage
```

### 7.2 CI/CD 集成

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npm test
      - run: npm run test:coverage
```

---

## 八、测试优先级

### 8.1 P0 - 必须测试

- [ ] 技能 CRUD 操作
- [ ] 配置读写操作
- [ ] 本地优先策略
- [ ] 错误处理

### 8.2 P1 - 应该测试

- [ ] 边界条件
- [ ] 并发操作
- [ ] 文件系统异常

### 8.3 P2 - 可以测试

- [ ] 性能测试
- [ ] 压力测试
- [ ] 兼容性测试

---

*本文档为 Skillix 项目测试计划*
*最后更新: 2026-01-11*
