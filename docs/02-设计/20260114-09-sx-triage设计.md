# sx-triage 智能分流设计

> 日期: 2026-01-14
> 更新: 2026-01-19 (AI First 实现调整)
> 关联: 20260111-03-自动创建与进化设计.md
> 状态: 已实现

---

## 一、概述

### 1.1 功能定位

`sx-triage` 是 Skillix 的智能分流工具，负责分析用户任务并推荐最佳操作。

**核心职责**：
- 分析用户输入的任务描述
- 匹配现有技能
- 推荐操作类型（使用/创建/安装等）
- 返回置信度和推荐理由

### 1.2 设计目标

1. **智能匹配** - 准确识别任务与技能的关联
2. **多策略** - 支持多种操作类型
3. **可解释** - 提供推荐理由
4. **低延迟** - 快速返回结果

---

## 二、分流流程

### 2.1 主流程

```mermaid
flowchart TD
    A[接收任务描述] --> B[预处理输入]
    B --> C[提取关键词]
    C --> D[获取技能列表]
    
    D --> E[技能匹配]
    E --> F{找到匹配?}
    
    F -->|是| G[评估匹配度]
    F -->|否| H[检查技能市场]
    
    G --> I{匹配度高?}
    I -->|是| J[USE_EXISTING]
    I -->|一般| K[IMPROVE_EXISTING]
    
    H --> L{市场有?}
    L -->|是| M[INSTALL]
    L -->|否| N[CREATE_NEW]
    
    J --> O[构建结果]
    K --> O
    M --> O
    N --> O
    
    O --> P[返回分流结果]
    
    style P fill:#90EE90
```

### 2.2 关键词提取流程

```mermaid
flowchart TD
    A[任务描述] --> B[分词处理]
    B --> C[去除停用词]
    C --> D[提取动作词]
    D --> E[提取对象词]
    E --> F[识别领域词]
    F --> G[构建关键词集]
    
    G --> H[关键词列表]
    
    style H fill:#90EE90
```

### 2.3 技能匹配流程

```mermaid
flowchart TD
    A[关键词集] --> B[遍历技能列表]
    
    B --> C[匹配技能名称]
    C --> D[匹配技能描述]
    D --> E[匹配技能标签]
    
    E --> F[计算匹配分数]
    F --> G{分数 > 阈值?}
    
    G -->|是| H[添加到候选列表]
    G -->|否| I[跳过]
    
    H --> J{还有技能?}
    I --> J
    
    J -->|是| B
    J -->|否| K[排序候选列表]
    
    K --> L[返回最佳匹配]
    
    style L fill:#90EE90
```

---

## 三、分流策略

### 3.1 操作类型

```mermaid
flowchart TD
    A[分流结果] --> B[USE_EXISTING]
    A --> C[IMPROVE_EXISTING]
    A --> D[CREATE_NEW]
    A --> E[INSTALL]
    A --> F[COMPOSE]
    A --> G[NO_SKILL_NEEDED]
    
    B --> B1[使用现有技能]
    C --> C1[改进现有技能]
    D --> D1[创建新技能]
    E --> E1[从市场安装]
    F --> F1[组合多个技能]
    G --> G1[无需技能]
```

### 3.2 决策逻辑

```mermaid
flowchart TD
    A[开始决策] --> B{本地有匹配?}
    
    B -->|高匹配| C[USE_EXISTING]
    B -->|中匹配| D{需要改进?}
    B -->|无匹配| E{市场有?}
    
    D -->|是| F[IMPROVE_EXISTING]
    D -->|否| C
    
    E -->|是| G[INSTALL]
    E -->|否| H{任务复杂?}
    
    H -->|是| I[CREATE_NEW]
    H -->|否| J[NO_SKILL_NEEDED]
    
    style C fill:#90EE90
    style F fill:#FFD700
    style G fill:#87CEEB
    style I fill:#DDA0DD
    style J fill:#D3D3D3
```

### 3.3 匹配度计算

```mermaid
flowchart TD
    A[计算匹配度] --> B[名称匹配分]
    A --> C[描述匹配分]
    A --> D[标签匹配分]
    
    B --> E["权重: 0.4"]
    C --> F["权重: 0.4"]
    D --> G["权重: 0.2"]
    
    E --> H[加权求和]
    F --> H
    G --> H
    
    H --> I[最终分数]
    
    I --> J{分数判定}
    J -->|>= 0.8| K[高匹配]
    J -->|>= 0.5| L[中匹配]
    J -->|< 0.5| M[低匹配]
    
    style K fill:#90EE90
    style L fill:#FFD700
    style M fill:#FFA07A
```

---

## 四、输入输出设计

### 4.1 输入参数

```mermaid
classDiagram
    class TriageParams {
        +string task
        +string context
        +string[] hints
        +string projectRoot
    }
```

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| task | string | ✅ | 任务描述 |
| context | string | ❌ | 上下文信息 |
| hints | string[] | ❌ | 提示词列表 |
| projectRoot | string | ❌ | 项目根目录 |

### 4.2 输出响应

```mermaid
classDiagram
    class TriageResponse {
        +boolean success
        +string message
        +TriageResult data
    }
    
    class TriageResult {
        +ActionType action
        +string skill
        +string source
        +float confidence
        +string reason
        +string[] alternatives
    }
    
    class ActionType {
        <<enumeration>>
        USE_EXISTING
        IMPROVE_EXISTING
        CREATE_NEW
        INSTALL
        COMPOSE
        NO_SKILL_NEEDED
    }
    
    TriageResponse --> TriageResult
    TriageResult --> ActionType
```

---

## 五、典型场景

### 5.1 使用现有技能

```mermaid
sequenceDiagram
    participant U as 用户
    participant AI as AI
    participant T as sx-triage
    participant S as sx-skill
    
    U->>AI: 帮我把 PDF 转成图片
    AI->>T: triage(task: "PDF 转图片")
    T->>S: list(scope: "all")
    S-->>T: 技能列表
    T->>T: 匹配 pdf-converter
    T-->>AI: USE_EXISTING, skill: pdf-converter
    AI->>S: read(name: "pdf-converter")
    S-->>AI: 技能内容
    AI->>U: 按照技能指引执行...
```

### 5.2 创建新技能

```mermaid
sequenceDiagram
    participant U as 用户
    participant AI as AI
    participant T as sx-triage
    participant S as sx-skill
    
    U->>AI: 帮我处理 XML 文件
    AI->>T: triage(task: "处理 XML 文件")
    T->>S: list(scope: "all")
    S-->>T: 技能列表（无匹配）
    T->>T: 检查市场（无匹配）
    T-->>AI: CREATE_NEW
    AI->>U: 建议创建新技能，是否创建？
    U->>AI: 是
    AI->>S: create(name: "xml-handler", ...)
    S-->>AI: 创建成功
```

### 5.3 从市场安装

```mermaid
sequenceDiagram
    participant U as 用户
    participant AI as AI
    participant T as sx-triage
    participant M as sx-market
    
    U->>AI: 帮我生成 API 文档
    AI->>T: triage(task: "生成 API 文档")
    T->>T: 本地无匹配
    T->>M: search(query: "api documentation")
    M-->>T: 找到 api-doc-gen
    T-->>AI: INSTALL, skill: api-doc-gen
    AI->>U: 市场有这个技能，是否安装？
    U->>AI: 是
    AI->>M: install(name: "api-doc-gen")
    M-->>AI: 安装成功
```

---

## 六、匹配算法

### 6.1 文本相似度

```mermaid
flowchart TD
    A[文本相似度计算] --> B[分词]
    B --> C[TF-IDF 向量化]
    C --> D[余弦相似度]
    D --> E[相似度分数]
    
    style E fill:#90EE90
```

### 6.2 关键词匹配

```mermaid
flowchart TD
    A[关键词匹配] --> B[提取任务关键词]
    B --> C[提取技能关键词]
    C --> D[计算交集]
    D --> E[Jaccard 系数]
    E --> F[匹配分数]
    
    style F fill:#90EE90
```

### 6.3 综合评分

```mermaid
flowchart TD
    A[综合评分] --> B[文本相似度]
    A --> C[关键词匹配]
    A --> D[标签匹配]
    
    B --> E["分数 × 0.4"]
    C --> F["分数 × 0.4"]
    D --> G["分数 × 0.2"]
    
    E --> H[求和]
    F --> H
    G --> H
    
    H --> I[最终分数]
    
    style I fill:#90EE90
```

---

## 七、置信度计算

### 7.1 置信度因素

```mermaid
flowchart TD
    A[置信度因素] --> B[匹配分数]
    A --> C[技能复杂度]
    A --> D[任务清晰度]
    A --> E[历史成功率]
    
    B --> F[基础置信度]
    C --> G[复杂度修正]
    D --> H[清晰度修正]
    E --> I[历史修正]
    
    F --> J[最终置信度]
    G --> J
    H --> J
    I --> J
    
    style J fill:#90EE90
```

### 7.2 置信度级别

```mermaid
flowchart LR
    A[置信度] --> B{级别判定}
    B -->|>= 0.9| C[非常高]
    B -->|>= 0.7| D[高]
    B -->|>= 0.5| E[中等]
    B -->|< 0.5| F[低]
    
    C --> G["直接执行"]
    D --> H["建议执行"]
    E --> I["询问确认"]
    F --> J["提供选项"]
    
    style C fill:#90EE90
    style D fill:#98FB98
    style E fill:#FFD700
    style F fill:#FFA07A
```

---

## 八、错误处理

### 8.1 错误场景

```mermaid
flowchart TD
    A[可能的错误] --> B[任务描述为空]
    A --> C[技能列表获取失败]
    A --> D[市场查询超时]
    A --> E[匹配算法异常]
    
    B --> B1[返回错误: 缺少任务描述]
    C --> C1[使用缓存或返回 CREATE_NEW]
    D --> D1[跳过市场匹配]
    E --> E1[返回 NO_SKILL_NEEDED]
    
    style B1 fill:#FFA07A
    style C1 fill:#FFD700
    style D1 fill:#FFD700
    style E1 fill:#D3D3D3
```

### 8.2 降级策略

```mermaid
flowchart TD
    A[分流失败] --> B{错误类型?}
    
    B -->|网络错误| C[仅使用本地技能]
    B -->|算法异常| D[返回默认结果]
    B -->|数据异常| E[返回错误信息]
    
    C --> F[继续分流]
    D --> G[NO_SKILL_NEEDED]
    E --> H[用户决定]
    
    style F fill:#98FB98
    style G fill:#D3D3D3
    style H fill:#FFD700
```

---

## 九、与其他工具的关系

### 9.1 工具关系图

```mermaid
flowchart TD
    subgraph sx-triage
        A[analyze]
    end
    
    subgraph sx-skill
        B[list]
        C[read]
        D[create]
        E[update]
    end
    
    subgraph sx-market
        F[search]
        G[install]
    end
    
    A -->|获取技能| B
    A -->|USE_EXISTING| C
    A -->|IMPROVE_EXISTING| E
    A -->|CREATE_NEW| D
    A -->|查询市场| F
    A -->|INSTALL| G
    
    style A fill:#87CEEB
```

### 9.2 完整工作流

```mermaid
flowchart TD
    A[用户请求] --> B[sx-triage 分析]
    
    B --> C{分流结果}
    
    C -->|USE_EXISTING| D[sx-skill read]
    C -->|IMPROVE_EXISTING| E[sx-skill update]
    C -->|CREATE_NEW| F[sx-skill create]
    C -->|INSTALL| G[sx-market install]
    C -->|COMPOSE| H[组合多个技能]
    C -->|NO_SKILL_NEEDED| I[直接执行]
    
    D --> J[执行任务]
    E --> J
    F --> D
    G --> D
    H --> J
    I --> J
    
    J --> K[完成]
    
    style K fill:#90EE90
```

---

## 十、配置选项

### 10.1 分流配置

```mermaid
classDiagram
    class TriageConfig {
        +float matchThreshold
        +float confidenceThreshold
        +boolean enableMarketSearch
        +int marketSearchTimeout
        +string[] preferredSources
    }
```

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| matchThreshold | float | 0.5 | 匹配阈值 |
| confidenceThreshold | float | 0.7 | 置信度阈值 |
| enableMarketSearch | boolean | true | 启用市场搜索 |
| marketSearchTimeout | int | 5000 | 市场搜索超时(ms) |
| preferredSources | string[] | ["official"] | 首选技能源 |

### 10.2 全局配置示例

```json
{
  "triage": {
    "matchThreshold": 0.5,
    "confidenceThreshold": 0.7,
    "enableMarketSearch": true,
    "marketSearchTimeout": 5000,
    "preferredSources": ["official"]
  }
}
```

---

## 十一、实现调整：AI First 设计

> 更新日期: 2026-01-19

### 11.1 设计理念调整

由于 Skillix 是给 AI 模型使用的 MCP 工具，实际实现采用了 **AI First** 设计理念：

**核心思想**：
- triage 工具只负责**收集信息**（本地技能、市场技能）
- **决策权交给 AI**
- AI 根据任务描述和技能列表自行判断最佳匹配

```mermaid
flowchart TD
    A[用户任务] --> B[sx-triage]
    B --> C[收集技能信息]
    C --> D[返回结构化数据]
    D --> E[AI 自行分析决策]
    E --> F[执行推荐操作]
    
    style E fill:#87CEEB
```

### 11.2 简化的实现

原设计中的复杂关键词处理（动作词、领域词、TF-IDF等）被简化为：

1. **基本分词** - 按空格和标点分割
2. **简单停用词过滤** - 只保留最常见的无意义词
3. **字符串匹配** - 简单的包含匹配计算相关性分数

**原因**：
- AI 本身具有强大的语义理解能力
- 复杂的关键词匹配反而可能干扰 AI 的判断
- 维护大量关键词列表成本高且覆盖不全

### 11.3 响应结构调整

返回给 AI 的结构化数据：

```typescript
{
  // 任务信息
  task: string,
  context: string | null,
  hints: string[],
  
  // 初步推荐（仅供参考，AI 可自行判断）
  recommendation: {
    action: TriageActionType,
    skill: string | null,
    source: string | null,
    confidence: number,
    reason: string,
  },
  
  // 可用技能列表（供 AI 分析选择）
  availableSkills: Array<{
    name: string,
    description: string,
    scope: 'global' | 'project' | 'market',
    source: string,
    relevanceScore: number,
  }>,
  
  // 下一步操作建议
  nextSteps: string[],
  
  // AI 决策提示
  aiHint: string,
}
```

### 11.4 AI 决策流程

AI 收到 triage 响应后：

1. 查看 `availableSkills` 列表
2. 根据任务描述判断哪个技能最匹配
3. 参考 `recommendation` 但可自行决策
4. 根据 `aiHint` 提示选择操作类型
5. 执行相应的后续操作

### 11.5 优势

| 方面 | 原设计（关键词匹配） | AI First 设计 |
|------|---------------------|---------------|
| 维护成本 | 高（需维护关键词列表） | 低 |
| 语义理解 | 弱（字面匹配） | 强（AI 理解） |
| 覆盖范围 | 有限 | 广泛 |
| 准确性 | 中等 | 高 |
| 灵活性 | 低 | 高 |

---

*本文档为 sx-triage 智能分流设计文档*
*最后更新: 2026-01-19*
